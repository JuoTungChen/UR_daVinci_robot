<?xml version="1.0"?>

<!-- da Vinci Large Needle Driver (LND) model 420006 (S/Si) and 470006 (X/Xi) -->
<robot name="lnd" xmlns:xacro="http://ros.org/wiki/xacro">

  <material name="tip_metallic_gray">
    <color rgba="0.667 0.663 0.678 1.0" />
  </material>
  <material name="rod_dark_grey">
    <color rgba="0.1 0.1 0.1 1.0" />
  </material>

  <xacro:macro name="lnd_tip" params="prefix" >
    <link name="${prefix}tip_calib" />

    <link name="${prefix}rotation">
      <visual>
        <origin xyz="0 0 -0.01" rpy="0 0 ${pi/2}" />
        <geometry>
          <mesh filename="package://mops_description/meshes/lnd_tip/roll.stl" />
        </geometry>
        <material name="tip_metallic_gray" />
      </visual>
    </link>

    <link name="${prefix}wrist">
      <visual>
        <origin xyz="0 0 0" rpy="0 0 ${pi/2}" />
        <geometry>
          <mesh filename="package://mops_description/meshes/lnd_tip/wrist.stl" />
        </geometry>
        <material name="tip_metallic_gray" />
      </visual>
    </link>

    <link name="${prefix}jaw_hinge" />

    <link name="${prefix}jaw0" />

    <link name="${prefix}jaw1">
      <visual>
        <origin xyz="0 0 0" rpy="0 ${pi/2} 0" />
        <geometry>
          <mesh filename="package://mops_description/meshes/lnd_tip/jaw.stl" />
        </geometry>
        <material name="tip_metallic_gray" />
      </visual>
    </link>

    <link name="${prefix}jaw2">
      <visual>
        <origin xyz="0 0 0" rpy="0 ${pi/2} 0" />
        <geometry>
          <mesh filename="package://mops_description/meshes/lnd_tip/jaw.stl" />
        </geometry>
        <material name="tip_metallic_gray" />
      </visual>
    </link>

    <link name="${prefix}tcp0" />

    <link name="${prefix}tcp1" />

    <link name="${prefix}tcp2" />

    <joint name="${prefix}roll" type="revolute">
      <parent link="${prefix}tip_calib" />
      <child link="${prefix}rotation" />
      <origin xyz="-0.018 0 0" rpy="${-pi} ${-pi/2} 0" />
      <axis xyz="0 0 1" />
      <limit lower="${radians(-260)}" upper="${radians(260)}" effort="0.3" velocity="${2*pi}" />
    </joint>

    <joint name="${prefix}pitch" type="revolute">
      <parent link="${prefix}rotation" />
      <child link="${prefix}wrist" />
      <origin xyz="0 0 0" rpy="${-pi/2} ${-pi/2} 0" />
      <axis xyz="0 0 1" />
      <limit lower="${radians(-80)}" upper="${radians(80)}" effort="0.25" velocity="${2*pi}" />
    </joint>

    <joint name="${prefix}jaw_hinge_fixed" type="fixed">
      <parent link="${prefix}wrist" />
      <child link="${prefix}jaw_hinge" />
      <origin xyz="0.0091 0 0" rpy="${pi/2} 0 0" />
    </joint>

    <!-- This is not a real physical joint, but rather yaw0 = (yaw1 - yaw2) / 2,
         ie. the TCP frame is at an angle between the grasper jaws. -->
    <joint name="${prefix}yaw0" type="revolute">
      <parent link="${prefix}jaw_hinge" />
      <child link="${prefix}jaw0" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <axis xyz="0 0 1" />
      <limit lower="${radians(-75)}" upper="${radians(75)}" effort="0.2" velocity="${2*pi}" />
    </joint>

    <joint name="${prefix}yaw1" type="revolute">
      <parent link="${prefix}jaw_hinge" />
      <child link="${prefix}jaw1" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <axis xyz="0 0 1" />
      <limit lower="${radians(-75)}" upper="${radians(75)}" effort="0.2" velocity="${2*pi}" />
    </joint>

    <joint name="${prefix}yaw2" type="revolute">
      <parent link="${prefix}jaw_hinge" />
      <child link="${prefix}jaw2" />
      <origin xyz="0 0 0" rpy="${pi} 0 0" />
      <axis xyz="0 0 1" />
      <limit lower="${radians(-75)}" upper="${radians(75)}" effort="0.2" velocity="${2*pi}" />
    </joint>

    <joint name="${prefix}tcp0_fixed" type="fixed">
      <parent link="${prefix}jaw0" />
      <child link="${prefix}tcp0" />
      <origin xyz="0.009 0 0" rpy="0 0 0" />
    </joint>

    <joint name="${prefix}tcp1_fixed" type="fixed">
      <parent link="${prefix}jaw1" />
      <child link="${prefix}tcp1" />
      <origin xyz="0.009 0 0" rpy="0 0 0" />
    </joint>

    <joint name="${prefix}tcp2_fixed" type="fixed">
      <parent link="${prefix}jaw2" />
      <child link="${prefix}tcp2" />
      <origin xyz="0.009 0 0" rpy="0 0 0" />
    </joint>
  </xacro:macro>


  <xacro:macro name="lnd420006" params="prefix">
    <xacro:lnd_tip prefix="${prefix}" />

    <link name="${prefix}rod">
      <visual>
        <geometry>
          <cylinder radius="0.004" length="0.457" />
        </geometry>
        <material name="rod_dark_grey" />
      </visual>
    </link>

    <joint name="${prefix}rod_joint" type="fixed">
      <parent link="${prefix}rotation" />
      <child link="${prefix}rod" />
      <origin xyz="0 0 ${-0.457/2 - 0.01}" rpy="0 0 0" />
    </joint>

    <link name="${prefix}housing">
      <visual>
        <origin xyz="-0.013 0 0" rpy="0 0 0" />
        <geometry>
          <box size="0.096 0.065 0.03" />
        </geometry>
        <material name="housing_light_blue">
          <color rgba="0.500 0.867 1.0 1.0" />
        </material>
      </visual>
    </link>

    <joint name="${prefix}housing_joint" type="fixed">
      <parent link="${prefix}tip_calib" />
      <child link="${prefix}housing" />
      <origin xyz="${-0.018 - 0.01 - 0.457} 0 0" rpy="0 0 0" />
    </joint>
  </xacro:macro>

  <xacro:macro name="lnd470006" params="prefix">
    <xacro:lnd_tip prefix="${prefix}" />

    <link name="${prefix}rod">
      <visual>
        <geometry>
          <cylinder radius="0.004" length="0.5335" />
        </geometry>
        <material name="rod_dark_grey" />
      </visual>
    </link>

    <joint name="${prefix}rod_joint" type="fixed">
      <parent link="${prefix}rotation" />
      <child link="${prefix}rod" />
      <origin xyz="0 0 ${-0.5335/2 - 0.01}" rpy="0 0 0" />
    </joint>

    <link name="${prefix}housing">
      <visual>
        <origin xyz="-0.015 0 -0.019" rpy="0 0 0" />
        <geometry>
          <box size="0.06 0.045 0.08" />
        </geometry>
        <material name="housing_white">
          <color rgba="1.0 1.0 1.0 1.0" />
        </material>
      </visual>
    </link>

    <joint name="${prefix}housing_joint" type="fixed">
      <parent link="${prefix}tip_calib" />
      <child link="${prefix}housing" />
      <origin xyz="${-0.018 - 0.01 - 0.5335} 0 0" rpy="0 0 0" />
    </joint>
  </xacro:macro>

</robot>
